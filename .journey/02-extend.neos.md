<walkthrough-metadata>
  <meta name="title" content="Serverless Journey>: Extend your code to call Cloud APIs" />
  <meta name="description" content="Learn how to call Cloud APIs directly from your code and use service accounts to secure your app." />
  <meta name="keywords" content="deploy, containers, console, run" />
</walkthrough-metadata>

# Serverless Journey: Extend your code to call Cloud APIs

![Tutorial header image](https://storage.googleapis.com/gweb-cloudblog-publish/images/databases_2022_HTRs5Tr.max-700x700.jpg)

In this tutorial we'll learn how to extend the existing code to call Cloud APIs directly. Currently, the deployed application uses a library which contains a static set of jokes. Whenever the library is used it randomly selects a joke and returns it. After a while we will surely start to see the same jokes again and the only way to see new jokes is when a human would actually implement them in the library.

Luckliy, there is a thing called _generative AI_ now. Google Cloud Vertex AI contains a Google-built, pre-trained, PaLM model which is a general-purpose, generative LLM that can be query with free-texts prompts to generate all sorts of text-based outputs. In this tutorial we'll implement the `model:predict` endpoint of Vertex AI to execute this model in order to new dad jokes in a generative matter.

Additionally, we'll learn a little bit about custom service accounts, IAM permissions and how to use the principle of least privilege to secure our services on Cloud Run.

<walkthrough-tutorial-difficulty difficulty="3"></walkthrough-tutorial-difficulty>

Estimated time:
<walkthrough-tutorial-duration duration="15"></walkthrough-tutorial-duration>

To get started, click **Start**.

## Project setup

First, let's make sure we got the correct project selected. Go ahead and select the provided project ID.

<walkthrough-project-setup billing="true"></walkthrough-project-setup>

Run the following to make sure all required APIs are enabled. Note that `aiplatform.googleapis.com` is added.

<walkthrough-enable-apis apis="cloudbuild.googleapis.com,
run.googleapis.com,aiplatform.googleapis.com,
artifactregistry.googleapis.com">
</walkthrough-enable-apis>

## Extending the code

In the cloud we often need to implement API calls to interact with other services. Platforms like Google Cloud are a large collection of APIs; if we learn how to use them we can use the entire wealth of Google Cloud's functionality in our applications and build almost anything!

There are typically three different ways to interact with Google APIs programmatically and we should choose them in the following order:

1. **Cloud Client Libraries**: These are the recommended option. Cloud Client Libraries are SDK that you can use in a language-native, idiomatic style. They give you a high-level interface to the most important operation and allow you to quickly and comfortably get the job done. An example in the Go eco-system would be the `cloud.google.com/go/storage` package, which implements the most commonly used operations of Google Cloud Storage. Have a look at the [documentation of the package](https://pkg.go.dev/cloud.google.com/go/storage) and see how it respects and implements native language concepts like the `io.Writer` interface of the Go progrogramming language.

2. **Google API Client Libraries**: Should no Cloud Client Library be available for what you are trying to accomplish you can fall back to using a Google API Client Library. These libraries are auto-generated and should be available for almost all Google APIs.

3. **Direct Implementation**: You can always choose to implement exposed APIs directly with your own client code. While most APIs are available as traditional RESTful services communicating JSON-serialized data, some APIs also implement [gRPC](https://grpc.io).

In order to be able to replace the statically created jokes with jokes generated by Vertex AI, the code needs to be extended in the following ways:

1. **Create a client to execute the remote model**: The first steps is to safely instantiate the correct client type, that we are going to use later on to interact with the API. This type holds all the configuration for endpoints and handles authentication, too. Have a look at the [documentation of the package](https://pkg.go.dev/cloud.google.com/go/aiplatform@v1.45.0/apiv1beta1#NewPredictionClient) for `aiplatform.PredictionClient`. The client will automatically look for credentials according to the rules of [Google's Application Default Credentials scheme](https://cloud.google.com/docs/authentication/application-default-credentials).

2. **Form a request object**: Executing a call against `model:predict` on Vertex AI requires the caller to send an object with some configuration needed by the API to run the prediction. Take a look at the [documentation of the type](https://pkg.go.dev/cloud.google.com/go/aiplatform@v1.45.0/apiv1beta1/aiplatformpb#PredictRequest) `aiplatformpb.PredictRequest`. One field of the type is asking to supply and `Endpoint string`. In order to use the Google-built _PaLM 2 for Text_ model, we'll set this property like this:

```go 
endpoint := fmt.Sprintf(
	"projects/%s/locations/us-central1/publishers/google/models/text-bison",
	project,
)
```

Have a look at the [Vertex AI Model Garden](https://console.cloud.google.com/vertex-ai/publishers/google/model-garden/text-bison) to learn more about _PaLM 2 for Text_ (`text-bison`) and other available models.

The call also requires other inputs, like the actual text prompt and parameters to tune the output of the model.

4. **Execute the call against the API to run the model prediction**: Finally, we'll use the previously instantiated client to actually send the `aiplatformpb.PredictRequest` and execute the API call. 

<!-- TODO reference function call -->


<!-- TODO change deps to tortuneai -->

<!-- TODO extending code base (hitme wants params now) -->

<!-- TODO new SA with perms for model:predict, tightening IAM -->

## Summary

You now know how to call Google APIs directly from your code and understand how to secure your services with least-privilege service accounts.

<walkthrough-conclusion-trophy></walkthrough-conclusion-trophy>

```bash
cloudshell launch-tutorial .journey/03-operate.neos.md
```

